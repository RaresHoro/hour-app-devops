name: Deploy to Azure Container App (main)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 app.py || echo "Lint warnings found"

      - name: Scan Python code with Bandit
        run: |
          pip install bandit
          bandit -r . || echo "Bandit scan completed"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build Docker image
        run: |
          docker build -t houracr.azurecr.io/hour-app:${{ github.sha }} .

      - name: Login to ACR
        run: az acr login --name houracr

      - name: Push Docker image to ACR
        run: docker push houracr.azurecr.io/hour-app:${{ github.sha }}

      - name: Create Container App Environment
        run: |
          ENV_EXISTS=$(az containerapp env show --name hour-env --resource-group my-rg --query name -o tsv || echo "")
          if [ -z "$ENV_EXISTS" ]; then
            az containerapp env create --name hour-env --resource-group my-rg --location westeurope
          fi

      - name: Create or Update Container App
        run: |
          APP_EXISTS=$(az containerapp show --name hour-app --resource-group my-rg --query name -o tsv || echo "")
          if [ -z "$APP_EXISTS" ]; then
            az containerapp create --name hour-app --resource-group my-rg --environment hour-env --image houracr.azurecr.io/hour-app:${{ github.sha }} --target-port 5000 --ingress external --registry-server houracr.azurecr.io --cpu 0.25 --memory 0.5Gi
          else
            az containerapp update --name hour-app --resource-group my-rg --image houracr.azurecr.io/hour-app:${{ github.sha }} --cpu 0.25 --memory 0.5Gi
          fi

      - name: Get app URL
        id: get-url
        run: |
          FQDN=$(az containerapp show \
            --name hour-app \
            --resource-group my-rg \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "APP_URL=https://${FQDN}" >> $GITHUB_ENV
          curl -f https://${FQDN}

      - name: Run OWASP ZAP baseline scan
        run: |
          if [ -z "${{ env.APP_URL }}" ]; then echo "APP_URL not found, skipping ZAP"; exit 0; fi
          mkdir -p zap-results && chmod -R 777 zap-results
          docker run --rm \
            -v ${{ github.workspace }}/zap-results:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ env.APP_URL }} \
            -r zap-report.html \
            -w zap-report.md \
            -T 60 || true

      - name: Upload ZAP HTML report
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: zap-results/zap-report.html

      - name: Vulnerability scan of image (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: houracr.azurecr.io/hour-app:${{ github.sha }}

  publish-zap-pages:
    needs: build-and-deploy
    if: ${{ needs.build-and-deploy.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download ZAP artifact
        uses: actions/download-artifact@v4
        with:
          name: zap-scan-report
          path: zap-report

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v3

      - name: Prepare public folder
        run: |
          mkdir -p public/zap/main
          cp zap-report/zap-report.html public/zap/main/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v2

      - name: Show link in summary
        run: |
          echo "::notice title=ZAP Report::[View ZAP Report](https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/zap/main/)"
