name: Deploy to Azure Container App (dev)

on:
  push:
    branches:
      - dev
    paths:
      - 'app.py'
      - 'Dockerfile'
      - '.github/workflows/deploy-dev.yml'

jobs:
  static-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 app.py || echo "Lint warnings found"

      - name: Scan Python code with Bandit
        run: |
          pip install bandit
          bandit -r . || echo "Bandit scan completed"

  build-and-push:
    needs: static-checks
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        run: az acr login --name houracr

      - name: Build and push using Docker Action
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: houracr.azurecr.io/hour-app-dev:${{ github.sha }}

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install wget -y
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.deb -O trivy.deb
          sudo dpkg -i trivy.deb


      - name: Generate Trivy HTML report
        run: |
          mkdir -p trivy-pages
          trivy image \
            --format template \
            --template "@contrib/html.tpl" \
            --output trivy-pages/index.html \
            --severity HIGH,CRITICAL \
            houracr.azurecr.io/hour-app-dev:${{ github.sha }}

      - name: Publish Trivy report to GitHub Pages
        if: github.ref == 'refs/heads/dev'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: trivy-pages
          destination_dir: trivy-dev-report
          keep_files: true

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    outputs:
      app_url: ${{ steps.get-url.outputs.app_url }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Container App Environment (if needed)
        run: |
          ENV_EXISTS=$(az containerapp env show --name hour-env --resource-group my-rg --query name -o tsv || echo "")
          if [ -z "$ENV_EXISTS" ]; then
            az containerapp env create --name hour-env --resource-group my-rg --location westeurope
          fi

      - name: Create or Update Container App
        run: |
          APP_EXISTS=$(az containerapp show --name hour-app-dev --resource-group my-rg --query name -o tsv || echo "")
          if [ -z "$APP_EXISTS" ]; then
            az containerapp create \
              --name hour-app-dev \
              --resource-group my-rg \
              --environment hour-env \
              --image houracr.azurecr.io/hour-app-dev:${{ github.sha }} \
              --target-port 5000 \
              --ingress external \
              --registry-server houracr.azurecr.io \
              --cpu 0.25 --memory 0.5Gi
          else
            az containerapp update \
              --name hour-app-dev \
              --resource-group my-rg \
              --image houracr.azurecr.io/hour-app-dev:${{ github.sha }} \
              --cpu 0.25 --memory 0.5Gi
          fi

      - name: Validate deployment is running
        id: get-url
        run: |
          URL=$(az containerapp show \
            --name hour-app-dev \
            --resource-group my-rg \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          echo "app_url=$URL" >> $GITHUB_OUTPUT
          curl -f https://$URL || exit 1

  scan-zap:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create zap-results directory
        run: |
          mkdir -p zap-results
          chmod -R 777 zap-results

      - name: Run OWASP ZAP
        run: |
          docker run --rm -v ${{ github.workspace }}/zap-results:/zap/wrk \
            -w /zap/wrk \
            ghcr.io/zaproxy/zaproxy \
            zap-baseline.py \
            -t https://${{ needs.deploy.outputs.app_url }} \
            -r zap-report.html \
            -d -T 60 || true

      - name: Publish ZAP report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: zap-results
          destination_dir: zap-dev-report
          keep_files: true
